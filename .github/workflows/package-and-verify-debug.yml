name: Package and verify (debug)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-package:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Install build dependencies (GLU)
      run: |
        sudo apt-get update
        sudo apt-get install -y libglu1-mesa-dev build-essential cmake

    - name: Configure CMake
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug

    - name: Build
      run: |
        cmake --build build --config Debug -- -j$(nproc)

    - name: Install
      run: |
        cmake --install build --config Debug --prefix build/install

    - name: Package (CPack)
      run: |
        cmake --build build --config Debug --target package

    - name: Verify package contains README.md
      run: |
        # Find produced ZIP and list its contents
        PACKAGE_DIR="$(pwd)/build/package"
        ZIP_FILE=$(ls $PACKAGE_DIR/*.zip 2>/dev/null | head -n1 || true)
        if [ -z "$ZIP_FILE" ]; then
          echo "No ZIP package found in $PACKAGE_DIR"
          exit 1
        fi
        unzip -l "$ZIP_FILE" | grep -i "README.md" || (echo "README.md not found in archive" && exit 1)

